Eden_treaty_start = {
	news_event = Eden_pact.1001
	hidden_effect = {
		set_variable = { global.Eden_treaty_progress = 0 }
		set_variable = { global.Eden_treaty_phase = token:Eden_treaty_phase_opening }
		set_global_flag = BA_2st_eden_pact_begin
		set_global_flag = Eden_treaty_negotiation_ongoing
		TRI = {
			set_variable = { Eden_treaty_weights = 0 }
			set_variable = { Eden_treaty_modifier_political_power_factor = 0.1 }
			set_variable = { Eden_treaty_modifier_stability_factor = 0.1 }
			set_variable = { Eden_treaty_modifier_war_support_factor = 0.1 }
			set_variable = { Eden_treaty_modifier_industrial_capacity_factory = 0.1 }
			set_variable = { Eden_treaty_modifier_research_speed_factor = 0.05 }
			activate_mission = Eden_treaty_mutual_negotiation
			if = {
				limit = { has_global_flag = BA_2st_eden_pact_GEH_leader }
				unlock_national_focus = TRI_choosing_pact_place
				add_stability = -0.1
				set_temp_variable = { loyalty_change = -0.05 }
				TRI_parliament_all_loyalty_change = yes
				TRI_unity_decrease_5 = yes
			}
		}
		GEH = {
			set_variable = { Eden_treaty_weights = 0 }
			set_variable = { Eden_treaty_modifier_political_power_factor = 0.1 }
			set_variable = { Eden_treaty_modifier_stability_factor = 0.1 }
			set_variable = { Eden_treaty_modifier_war_support_factor = 0.1 }
			set_variable = { Eden_treaty_modifier_industrial_capacity_factory = 0.1 }
			set_variable = { Eden_treaty_modifier_research_speed_factor = 0.05 }
			activate_mission = Eden_treaty_mutual_negotiation
			if = {
				limit = { has_global_flag = BA_2st_eden_pact_TRI_leader }
				unlock_national_focus = GEH_restart_eden_treaty_negotiation
				#TODO:格黑娜未能触发的惩罚
			}
		}
	}
	
}
Eden_treaty_change_progress = { #改变筹备度
	custom_effect_tooltip = Eden_treaty_change_progress_tt
	add_to_variable = { global.Eden_treaty_progress = progress_change }
	clamp_variable = {
		var = global.Eden_treaty_progress
		min = 0
		max = 100
	}
	if = {
		limit = { check_variable = { global.Eden_treaty_progress = 100 } }
		Eden_treaty_next_phase = yes
	}
}
Eden_treaty_change_weights = { #改变贡献度
	if = {
		limit = { check_variable = { weights_change > 0 } }
		set_temp_variable = { gain_factor = 1 }
		add_to_temp_variable = { gain_factor = modifier@Eden_treaty_weights_gain_factor }
		multiply_temp_variable = { weights_change = gain_factor }
	}
	custom_effect_tooltip = Eden_treaty_change_weights_tt
	add_to_variable = { Eden_treaty_weights = weights_change }
	clamp_variable = {
		var = Eden_treaty_weights
		min = 0
	}
}
Eden_treaty_next_phase = {
	hidden_effect = {
		set_variable = { TRI_weights@var:global.Eden_treaty_phase = TRI.Eden_treaty_weights }
		set_variable = { GEH_weights@var:global.Eden_treaty_phase = GEH.Eden_treaty_weights }
		set_temp_variable = { TRI_point = TRI.Eden_treaty_weights }
		set_temp_variable = { GEH_point = GEH.Eden_treaty_weights }
		#开局阶段结束
		if = {
			limit = { check_variable = { global.Eden_treaty_phase = token:Eden_treaty_phase_opening } }
			set_variable = { global.Eden_treaty_phase = token:Eden_treaty_phase_negotiating }
			set_variable = { global.Eden_treaty_progress = 0 }
		}
		#谈判阶段结束
		else_if = {
			limit = { check_variable = { global.Eden_treaty_phase = token:Eden_treaty_phase_negotiating } }
			set_variable = { global.Eden_treaty_phase = token:Eden_treaty_phase_agreement }
			set_variable = { global.Eden_treaty_progress = 0 }
			if = {
				limit = { check_variable = { global.Eden_treaty_negotiation_phase_leader^0 = TRI } }
				set_temp_variable = { extra_point = GEH_weights@var:global.Eden_treaty_phase_opening }
				multiply_temp_variable = { extra_point = 0.15 }
				add_to_temp_variable = { GEH_point = extra_point }
			}
			else_if = {
				limit = { check_variable = { global.Eden_treaty_negotiation_phase_leader^0 = GEH } }
				set_temp_variable = { extra_point = TRI_weights@var:global.Eden_treaty_phase_opening }
				multiply_temp_variable = { extra_point = 0.15 }
				add_to_temp_variable = { TRI_point = extra_point }
			}
		}
		#协议阶段结束
		else = {
			clr_global_flag = Eden_treaty_negotiation_ongoing
			set_global_flag = Eden_treaty_negotiation_completed
			activate_mission = Eden_treaty_to_be_signed
            140 = {
                set_demilitarized_zone = yes
            }
            529 = {
                set_demilitarized_zone = yes
            }
			if = {
				limit = { check_variable = { global.Eden_treaty_negotiation_phase_leader^1 = TRI } }
				set_temp_variable = { extra_point = GEH_weights@var:global.Eden_treaty_phase_negotiating }
				multiply_temp_variable = { extra_point = 0.15 }
				add_to_temp_variable = { GEH_point = extra_point }
			}
			else_if = {
				limit = { check_variable = { global.Eden_treaty_negotiation_phase_leader^1 = GEH } }
				set_temp_variable = { extra_point = TRI_weights@var:global.Eden_treaty_phase_negotiating }
				multiply_temp_variable = { extra_point = 0.15 }
				add_to_temp_variable = { TRI_point = extra_point }
			}
			clear_variable = global.Eden_treaty_phase
			clear_variable = global.Eden_treaty_progress
			TRI = {
				country_event = Eden_pact.100
				clear_variable = Eden_treaty_weights
			}
			GEH = {
				country_event = Eden_pact.100
				clear_variable = Eden_treaty_weights
			}
		}
		if = {
			limit = { check_variable = { TRI_point > GEH_point } }
			add_to_array = { global.Eden_treaty_negotiation_phase_leader = TRI }
			add_to_variable = { global.Eden_treaty_TRI_score = 1 }
		}
		else_if = {
			limit = { check_variable = { TRI_point < GEH_point } }
			add_to_array = { global.Eden_treaty_negotiation_phase_leader = GEH }
			add_to_variable = { global.Eden_treaty_GEH_score = 1 }
		}
		else = {
			add_to_array = { global.Eden_treaty_negotiation_phase_leader = 0 }
		}
	}
}
Eden_treaty_get_winner = {
	hidden_effect = {
		if = {
			limit = { check_variable = { global.Eden_treaty_TRI_score > global.Eden_treaty_GEH_score } }
			set_global_flag = Eden_treaty_negotiation_TRI_win
			TRI = {
				country_event = {
					id = Eden_pact.101
					days = 2
				}
			}
			GEH = {
				country_event = {
					id = Eden_pact.101
					days = 2
				}
			}
		}
		else_if = {
			limit = { check_variable = { global.Eden_treaty_TRI_score < global.Eden_treaty_GEH_score } }
			set_global_flag = Eden_treaty_negotiation_GEH_win
			TRI = {
				country_event = {
					id = Eden_pact.102
					days = 2
				}
			}
			GEH = {
				country_event = {
					id = Eden_pact.102
					days = 2
				}
			}
		}
		else = {
			TRI = {
				country_event = {
					id = Eden_pact.103
					days = 2
				}
			}
			GEH = {
				country_event = {
					id = Eden_pact.103
					days = 2
				}
			}
		}
	}
}
Cathedral_war_ARI_cathedral_fall = {
	dismantle_faction = yes
	delete_units = {
		division_template = "圣徒会的投影"
		disband = no
	}
	if = {
		limit = { 
			SCH = {
				is_in_faction = no
			}
		}
		TRI = {
			create_faction = TRI_AND_GEH_FACTION_NAME
			add_to_faction = GEH
		}
	}
	Eden_treaty_formally_signed = yes
}
Cathedral_war_ARI_defeated = {
	set_global_flag = Arius_defeated
	white_peace = {
		tag = GEH
		tooltip = WAR_GST_JS_LOC
	}
	white_peace = {
		tag = TRI
		tooltip = WAR_GST_JS_LOC
	}
	if = {
		limit = { 
			TRI = {
				has_war_with = GEH
			}
		}
		TRI = {
			white_peace = {
				tag = GEH
				tooltip = WAR_GST_JS_LOC
			}
		}
	}
	140 = {
		transfer_state_to = TRI #转移控制者和拥有者给予指定TAG
	}

	529 = {
		transfer_state_to = TRI #转移控制者和拥有者给予指定TAG
	}

	###移出所有因古圣堂之战而出现的动态修正并自动营救所有学生###
		for_each_scope_loop = {
			array = global.GST_JS_ZBH
			remove_dynamic_modifier = {
				modifier = TRI_ARI_GEH_JingPiLiJie
			}
			remove_dynamic_modifier = {
				modifier = TRI_BeiAliWuSiTuXi
			}
		}
		for_each_loop = {
			array = global.ARI_ShouHaiZheMingDan_SAN
			value = v
			var:v = {
				clr_character_flag = ARI_BeiBangJia
			}
		}
		for_each_loop = {
			array = global.ARI_ShouHaiZheMingDan_ER
			value = v
			var:v = {
				clr_character_flag = ARI_BeiBangJia
			}
		}
	###结束###
	load_focus_tree = ARI_NULL
	country_lock_all_division_template = yes
	add_ideas = {
		ARI_JSL
	}
	TRI = {
		country_event = LS_GST.51
	}
	GEH = {
		country_event = LS_GST.52
	}
}
Eden_treaty_formally_signed = {
	custom_effect_tooltip = Eden_treaty_has_been_signed
	set_global_flag = Eden_treaty_has_been_signed
	for_each_scope_loop = {
		array = global.Eden_treaty_negotiation_phase_leader
		add_political_power = 100
		add_to_variable = { Eden_treaty_modifier_political_power_factor = 0.05 }
		add_to_variable = { Eden_treaty_modifier_stability_factor = 0.05 }
		add_to_variable = { Eden_treaty_modifier_war_support_factor = 0.05 }
		add_to_variable = { Eden_treaty_modifier_industrial_capacity_factory = 0.05 }
		add_to_variable = { Eden_treaty_modifier_research_speed_factor = 0.025 }
	}
	TRI = {
		add_political_power = 100
		add_dynamic_modifier = { modifier = Eden_treaty_modifier }
	}
	GEH = {
		add_political_power = 100
		add_dynamic_modifier = { modifier = Eden_treaty_modifier }
	}
}